<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Reporte de Eventos - Taller Mec√°nico</title>

<style>
* { margin: 0; padding: 0; box-sizing: border-box; }

:root {
  --bet-green: #80B50A;
  --bet-green-dark: #6FA009;
  --bet-border: #5F8C08;
}

body {
  font-family: 'Roboto','Arial',sans-serif;
  background: #ffffff;
  min-height: 100vh;
  padding: 40px 20px;
}

body::before {
  content: '';
  position: fixed;
  inset: 0;
  background-image: repeating-linear-gradient(
    90deg,
    transparent,
    transparent 2px,
    rgba(128,181,10,.05) 2px,
    rgba(128,181,10,.05) 4px
  );
  pointer-events: none;
}

.container {
  max-width: 900px;
  margin: auto;
}

/* HEADER */
.header {
  background: linear-gradient(135deg, var(--bet-green), var(--bet-green-dark));
  border: 3px solid var(--bet-border);
  border-radius: 12px 12px 0 0;
  padding: 28px 32px;
  display: flex;
  align-items: center;
  justify-content: space-between;
  box-shadow: 0 8px 32px rgba(128,181,10,.35);
}

.header h1 {
  color: #fff;
  font-size: 26px;
  font-weight: 900;
  text-transform: uppercase;
}

.header p {
  color: #fff;
  font-size: 14px;
  opacity: .95;
}

.header img {
  height: 55px;
  background: #fff;
  padding: 8px 12px;
  border-radius: 8px;
}

/* FORM */
form {
  background: #ffffff;
  padding: 40px;
  border-radius: 0 0 12px 12px;
  border: 3px solid var(--bet-border);
  border-top: none;
}

.form-section {
  background: #f9f9f9;
  padding: 24px;
  border-radius: 8px;
  margin-bottom: 28px;
  border-left: 4px solid var(--bet-green);
}

.section-title {
  font-size: 16px;
  font-weight: 800;
  color: var(--bet-green);
  margin-bottom: 18px;
  padding-bottom: 10px;
  border-bottom: 2px solid #ddd;
  text-transform: uppercase;
}

.form-row {
  display: grid;
  grid-template-columns: repeat(auto-fit,minmax(250px,1fr));
  gap: 20px;
}

.form-group {
  display: flex;
  flex-direction: column;
}

label {
  color: var(--bet-green);
  font-weight: 600;
  margin-bottom: 6px;
}

input, select, textarea {
  padding: 12px;
  border-radius: 6px;
  border: 2px solid #ccc;
  font-size: 15px;
  background: #fff;
}

input:focus, select:focus, textarea:focus {
  border-color: var(--bet-green);
  outline: none;
  box-shadow: 0 0 0 3px rgba(128,181,10,.2);
}

input[type="file"] {
  border: 2px dashed var(--bet-green);
  color: var(--bet-green);
}

textarea { min-height: 100px; }

/* PROGRESS */
.upload-progress {
  display: none;
  margin-top: 20px;
  padding: 20px;
  border-radius: 8px;
  border: 2px solid var(--bet-green);
  background: #f1f8e9;
}

.progress-label,
.progress-text {
  color: var(--bet-green);
  font-weight: 600;
  text-align: center;
}

.progress-bar-container {
  height: 12px;
  background: #ddd;
  border-radius: 8px;
  overflow: hidden;
  margin: 10px 0;
}

.progress-bar {
  height: 100%;
  width: 0%;
  background: linear-gradient(90deg, var(--bet-green), var(--bet-green-dark));
  transition: width 0.3s ease;
}

/* BUTTONS */
.btn-primary {
  width: 100%;
  padding: 18px;
  background: linear-gradient(135deg, var(--bet-green), var(--bet-green-dark));
  color: #fff;
  font-size: 18px;
  font-weight: 900;
  border: none;
  border-radius: 8px;
  cursor: pointer;
  text-transform: uppercase;
  transition: all 0.3s ease;
}

.btn-primary:hover:not(:disabled) {
  transform: translateY(-2px);
  box-shadow: 0 8px 30px rgba(128,181,10,.5);
}

.btn-primary:disabled {
  opacity: 0.6;
  cursor: not-allowed;
}

.btn-secondary {
  border: 2px solid var(--bet-green);
  color: var(--bet-green);
  background: transparent;
  padding: 12px 24px;
  border-radius: 6px;
  cursor: pointer;
  margin: 5px;
  transition: all 0.3s ease;
}

.btn-secondary:hover {
  background: var(--bet-green);
  color: #fff;
}

/* FOLIO */
.folio-card {
  display: none;
  margin-top: 24px;
  padding: 32px;
  border-radius: 12px;
  border: 3px solid var(--bet-green);
  background: #f9f9f9;
  text-align: center;
}

.folio-card h3 {
  color: var(--bet-green);
  font-size: 20px;
  margin-bottom: 10px;
}

.folio-number {
  font-size: 42px;
  font-weight: 900;
  color: var(--bet-green-dark);
  margin: 16px 0;
  letter-spacing: 3px;
}

.folio-actions {
  margin: 20px 0;
}

.folio-note {
  margin-top: 15px;
  font-size: 14px;
  color: #666;
}

/* STATUS */
.status-message {
  margin-top: 20px;
  padding: 16px;
  border-radius: 8px;
  font-weight: 600;
  text-align: center;
  display: none;
}

.status-message.success {
  display: block;
  background: #e8f5e9;
  border: 2px solid var(--bet-green);
  color: var(--bet-green-dark);
}

.status-message.error {
  display: block;
  background: #fdecea;
  border: 2px solid #c62828;
  color: #c62828;
}

.status-message.info {
  display: block;
  background: #e3f2fd;
  border: 2px solid #1565c0;
  color: #1565c0;
}

@media (max-width:640px) {
  .header { flex-direction: column; gap: 16px; }
  body { padding: 20px 10px; }
  form { padding: 20px; }
}
</style>
</head>

<body>

<div class="container">
  <div class="header">
    <h1>üîß Reporte de Eventos - Taller Mec√°nico</h1>
  </div>

  <form id="formReporte">
    
    <div class="form-section">
      <div class="section-title">
        <span>üìÖ</span> Informaci√≥n del Evento
      </div>
      
      <div class="form-row">
        <div class="form-group">
          <label for="fechaEvento">Fecha del evento *</label>
          <input type="date" id="fechaEvento" name="fechaEvento" required>
        </div>
        <div class="form-group">
          <label for="horaEvento">Hora del suceso *</label>
          <input type="time" id="horaEvento" name="horaEvento" required>
        </div>
      </div>
    </div>

    <div class="form-section">
      <div class="section-title">
        <span>üöó</span> Informaci√≥n de la Unidad
      </div>
      
      <div class="form-row">
        <div class="form-group">
          <label for="placa">Placa</label>
          <input type="text" id="placa" name="placa" placeholder="Ej: UNI001">
        </div>
        <div class="form-group">
          <label for="marca_y_submarca">Marca y Submarca</label>
          <input type="text" id="marca_y_submarca" name="marca_y_submarca" placeholder="Ej: Renault Kangoo">
        </div>
      </div>
    </div>

    <div class="form-section">
      <div class="section-title">
        <span>üë•</span> Responsables
      </div>
      
      <div class="form-row">
        <div class="form-group">
          <label for="gerente">Gerente</label>
          <input type="text" id="gerente" name="gerente" placeholder="Nombre del gerente">
        </div>
        <div class="form-group">
          <label for="driver">Driver</label>
          <input type="text" id="driver" name="driver" placeholder="Nombre del conductor">
        </div>
      </div>
      
      <div class="form-group">
        <label for="telefono">Tel√©fono de contacto</label>
        <input type="tel" id="telefono" name="telefono" placeholder="55 1234 5678">
      </div>
    </div>

    <div class="form-section">
      <div class="section-title">
        <span>üìç</span> Ubicaci√≥n
      </div>
      
      <div class="form-group">
        <label for="proyecto">Proyecto</label>
        <input type="text" id="proyecto" name="proyecto" placeholder="Nombre del proyecto">
      </div>
      
      <div class="form-row">
        <div class="form-group">
          <label for="tienda">Tienda</label>
          <input type="text" id="tienda" name="tienda" placeholder="Nombre de la tienda">
        </div>
        <div class="form-group">
          <label for="ciudad_alcaldia">Ciudad / Alcald√≠a</label>
          <input type="text" id="ciudad_alcaldia" name="ciudad_alcaldia" placeholder="Ubicaci√≥n">
        </div>
      </div>
    </div>

    <div class="form-section">
      <div class="section-title">
        <span>üìù</span> Detalles del Reporte
      </div>
      
      <div class="form-group">
        <label for="seguro">¬øCuenta con seguro?</label>
        <select id="seguro" name="seguro">
          <option value="No" selected>No</option>
          <option value="S√≠">S√≠</option>
        </select>
      </div>
      
      <div class="form-group">
        <label for="descripcion">Descripci√≥n del evento</label>
        <textarea id="descripcion" name="descripcion" placeholder="Describa detalladamente lo sucedido..."></textarea>
      </div>
      
      <div class="form-group">
        <label for="evidencias">üì∏ Evidencias fotogr√°ficas (m√°x. 10)</label>
        <input type="file" id="evidencias" name="evidencias[]" accept="image/*" multiple>
      </div>
    </div>

    <div class="upload-progress" id="uploadProgress">
      <div class="progress-label">Procesando evidencias...</div>
      <div class="progress-bar-container">
        <div class="progress-bar" id="uploadBar"></div>
      </div>
      <div class="progress-text" id="uploadPct">0%</div>
    </div>

    <button type="button" class="btn-primary" id="botonEnviar">
      üöÄ Generar Folio y Guardar en Google Sheets
    </button>

    <div class="status-message" id="status"></div>

    <div class="folio-card" id="folioBox">
      <h3>‚úÖ Folio Asignado</h3>
      <div class="folio-number" id="folioValue">FOL-0000</div>
      
      <div class="folio-actions">
        <button type="button" class="btn-secondary" id="btnCopiarFolio">
          üìã Copiar Folio
        </button>
        <button type="button" class="btn-secondary" id="btnAbrirWhatsApp">
          üí¨ Enviar por WhatsApp
        </button>
      </div>
      
      <div class="folio-note">
        El folio ha sido registrado en Google Sheets y la carpeta de evidencias se cre√≥ en Google Drive.
      </div>
    </div>

  </form>
</div>

<script>
// ============================================
// CONFIGURACI√ìN - PEGA AQU√ç TU URL DE GOOGLE APPS SCRIPT
// ============================================
const GOOGLE_WEBAPP = "https://script.google.com/macros/s/AKfycbxeJItwMif5RSbjR_6u1vBnEJhFqvXPtZFle24feAkPbCHlbgwA-iu3sJZB3pzaMm9S3w/exec";

function vCampo(id) { 
  return document.getElementById(id).value.trim(); 
}

function construirResumenParaWhatsApp(d) {
  return [
    "üîß *REPORTE DE EVENTO - TALLER MEC√ÅNICO*",
    "‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê",
    "",
    `üßæ *Folio:* ${d.folio}`,
    `üìÖ *Fecha:* ${d.fecha_evento}`,
    `üïê *Hora:* ${d.hora_suceso}`,
    "",
    "üöó *UNIDAD Y PROYECTO*",
    `   Placa: ${d.placa}`,
    `   Marca y submarca: ${d.marca_y_submarca}`,
    "",
    "üë• *RESPONSABLES*",
    `   Gerente: ${d.gerente}`,
    `   Driver: ${d.driver}`,
    `   Tel√©fono: ${d.telefono}`,
    "",
    "üìç *UBICACI√ìN*",
    `   Proyecto: ${d.proyecto}`,
    `   Tienda: ${d.tienda}`,
    `   Ciudad: ${d.ciudad_alcaldia}`,
    "",
    `üõ°Ô∏è *Seguro:* ${d.seguro}`,
    "",
    "üìù *DESCRIPCI√ìN:*",
    d.descripcion,
    "",
    "‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê",
    `üì∏ Evidencias: ${d.num_imagenes} imagen(es)`,
    "‚úÖ Registrado en Google Sheets"
  ].join("\n");
}

const btnEnviar = document.getElementById("botonEnviar");
const statusEl = document.getElementById("status");
const folioBox = document.getElementById("folioBox");
const folioValue = document.getElementById("folioValue");

btnEnviar.onclick = async function() {
  // Validar campos requeridos
  if (!vCampo("fechaEvento") || !vCampo("horaEvento")) {
    statusEl.className = "status-message error";
    statusEl.textContent = "‚ùå Por favor complete la fecha y hora del evento";
    return;
  }

  btnEnviar.disabled = true;
  folioBox.style.display = "none";
  statusEl.className = "status-message info";
  statusEl.textContent = "‚è≥ Procesando informaci√≥n...";

  const fotos = [...document.getElementById("evidencias").files].slice(0, 10);
  const prog = document.getElementById("uploadProgress");
  const bar = document.getElementById("uploadBar");
  const pct = document.getElementById("uploadPct");
  
  if (fotos.length > 0) {
    prog.style.display = "block";
    statusEl.textContent = "‚è≥ Procesando evidencias fotogr√°ficas...";
  }

  const evidencias = [];
  try {
    for (let i = 0; i < fotos.length; i++) {
      const b64 = await toBase64(fotos[i]);
      evidencias.push({
        data: b64.split(",")[1],
        tipo: fotos[i].type,
        nombre: fotos[i].name
      });
      const p = Math.round(((i + 1) / fotos.length) * 100);
      bar.style.width = p + "%";
      pct.textContent = p + "%";
    }
  } catch (errorFoto) {
    statusEl.className = "status-message error";
    statusEl.textContent = "‚ùå Error al procesar las fotos. Intente nuevamente.";
    btnEnviar.disabled = false;
    prog.style.display = "none";
    console.error("Error procesando fotos:", errorFoto);
    return;
  }

  statusEl.textContent = "üíæ Guardando en Google Sheets...";

  try {
    const datos = {
      fecha_evento: vCampo("fechaEvento"),
      hora_suceso: vCampo("horaEvento"),
      placa: vCampo("placa"),
      marca_y_submarca: vCampo("marca_y_submarca"),
      gerente: vCampo("gerente"),
      driver: vCampo("driver"),
      telefono: vCampo("telefono"),
      tienda: vCampo("tienda"),
      ciudad_alcaldia: vCampo("ciudad_alcaldia"),
      proyecto: vCampo("proyecto"),
      seguro: vCampo("seguro"),
      descripcion: vCampo("descripcion"),
      evidencias: evidencias
    };

    console.log("Enviando a Google Sheets:", GOOGLE_WEBAPP);
    console.log("Datos:", datos);

    const response = await fetch(GOOGLE_WEBAPP, {
      method: "POST",
      headers: { 
        "Content-Type": "text/plain"
      },
      body: JSON.stringify(datos),
      redirect: 'follow'
    });
    
    const responseText = await response.text();
    console.log("Respuesta recibida:", responseText);
    
    const result = JSON.parse(responseText);
    
    if (result.status !== "success") {
      throw new Error(result.message || "Error al procesar el reporte");
    }

    const folioFmt = result.folio;
    folioValue.textContent = folioFmt;
    folioBox.style.display = "block";

    const resumen = construirResumenParaWhatsApp({
      ...datos, 
      folio: folioFmt,
      num_imagenes: fotos.length
    });
    
    document.getElementById("btnCopiarFolio").onclick = function() {
      navigator.clipboard.writeText(folioFmt);
      alert("‚úÖ Folio copiado al portapapeles");
    };
    
    document.getElementById("btnAbrirWhatsApp").onclick = function() {
      window.open(`https://api.whatsapp.com/send?text=${encodeURIComponent(resumen)}`, "_blank");
    };

    statusEl.className = "status-message success";
    statusEl.textContent = `‚úÖ Reporte guardado exitosamente en Google Sheets con folio ${folioFmt}`;
    
    prog.style.display = "none";
    
    setTimeout(() => {
      if (confirm("¬øDeseas crear otro reporte?")) {
        location.reload();
      }
    }, 3000);

  } catch (error) {
    statusEl.className = "status-message error";
    statusEl.textContent = "‚ùå Error: " + error.message;
    btnEnviar.disabled = false;
    prog.style.display = "none";
    console.error("Error completo:", error);
    console.error("Stack:", error.stack);
  }
};

function toBase64(f) {
  return new Promise((resolve, reject) => {
    const fr = new FileReader();
    fr.onload = () => resolve(fr.result);
    fr.onerror = (error) => reject(error);
    fr.readAsDataURL(f);
  });
}
</script>

</body>
</html>
