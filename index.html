<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>FORMULARIO INCIDENTES</title>
<style>
  body { font-family: Arial, sans-serif; margin: 20px; background:#f4f6f9; }
  form { background:#fff; padding:18px; border-radius:10px; max-width:600px; margin:auto; box-shadow:0 2px 8px rgba(0,0,0,0.08); }
  label{display:block;margin-top:10px;font-weight:600}
  input, textarea { width:100%; padding:8px; margin-top:6px; border-radius:6px; border:1px solid #ccc; box-sizing:border-box; }
  button{margin-top:14px;background:#007bff;color:#fff;padding:10px 14px;border-radius:6px;border:0;font-size:16px;cursor:pointer}
  button[disabled]{opacity:.6;cursor:not-allowed}
  #mensaje{margin-top:12px;font-weight:700;color:green;text-align:center}
  #error{margin-top:8px;font-weight:700;color:#c00;text-align:center}
</style>
</head>
<body>

<form id="eventoForm" onsubmit="return false;">
  <label>Fecha:</label>
  <input type="date" id="fecha" required>

  <label>Hora:</label>
  <input type="time" id="hora" required>

  <label>Placas:</label>
  <input type="text" id="placas" required>

  <label>Unidad:</label>
  <input type="text" id="unidad" required>

  <label>Gerente:</label>
  <input type="text" id="gerente" required>

  <label>Driver:</label>
  <input type="text" id="driver" required>

  <label>Tel√©fono Driver:</label>
  <input type="text" id="telefonoDriver" required>

  <label>Proyecto:</label>
  <input type="text" id="proyecto" required>

  <label>Tienda:</label>
  <input type="text" id="tienda" required>

  <label>Estado:</label>
  <input type="text" id="estado" required>

  <label>Ciudad:</label>
  <input type="text" id="ciudad" required>

  <label><input type="checkbox" id="requiereSeguro"> Requiere seguro</label>

  <label>Descripci√≥n:</label>
  <textarea id="descripcion" rows="4"></textarea>

  <button id="enviarBtn" type="button">Enviar reporte (WhatsApp)</button>

  <p id="mensaje"></p>
  <p id="error"></p>
</form>

<script>
/* CONFIGURA: reemplaza con tu endpoint SheetDB si aplica */
const SHEETDB_URL = "https://sheetdb.io/api/v1/2nam4r8p6zvef"; // <-- reemplaza si hace falta

// Helper: toma valor y si est√° vac√≠o devuelve '-'
function valOrDash(id) {
  const el = document.getElementById(id);
  if (!el) return "-";
  const v = (el.type === "checkbox") ? (el.checked ? "S√≠" : "No") : (el.value || "").trim();
  return v === "" ? "-" : v;
}

// Generar folio robusto (tolerante a formatos de respuesta)
async function generarFolio() {
  try {
    const res = await fetch(SHEETDB_URL);
    if (!res.ok) return "FOL-0001";
    const data = await res.json();
    let rows = [];
    if (Array.isArray(data)) rows = data;
    else if (data && Array.isArray(data.data)) rows = data.data;
    else rows = [];
    if (rows.length === 0) return "FOL-0001";
    for (let i = rows.length - 1; i >= 0; i--) {
      const r = rows[i];
      const fol = r && (r.folio || r.Folio || r.FOLIO) ? (r.folio || r.Folio || r.FOLIO) : null;
      if (fol && typeof fol === "string") {
        const parts = fol.split("-");
        const numPart = parts[1] ? parts[1].replace(/\D/g, "") : null;
        const num = numPart ? parseInt(numPart,10) : NaN;
        if (!isNaN(num)) return `FOL-${(num+1).toString().padStart(4,"0")}`;
      }
    }
    return "FOL-0001";
  } catch (err) {
    console.error("generarFolio:", err);
    return "FOL-0001";
  }
}

// Construye el resumen (con campos garantizados)
function construirResumen(form) {
  const folio = form.folio;
  // usamos valOrDash para garantizar que no queden vac√≠os
  const fechaEvento = valOrDash("fecha");
  const horaEvento = valOrDash("hora");
  const placas = valOrDash("placas");
  const unidad = valOrDash("unidad");
  const gerente = valOrDash("gerente");
  const driver = valOrDash("driver");
  const telefono = valOrDash("telefonoDriver");
  const tienda = valOrDash("tienda");
  const ciudad = valOrDash("ciudad");
  const estado = valOrDash("estado");
  const proyecto = valOrDash("proyecto");
  const seguro = valOrDash("requiereSeguro");
  const descripcion = valOrDash("descripcion");

  const fechaEnvio = form.fecha_envio;
  const horaEnvio = form.hora_envio;

  // Formato final (sin caracteres extra√±os que a veces se muestran)
  const lines = [
    "üìã Reporte de Evento",
    `üÜî Folio: ${folio}`,
    `üìÖ Fecha del evento: ${fechaEvento} ${horaEvento}`,
    `üïí Enviado: ${fechaEnvio} ${horaEnvio}`,
    `üöõ Unidad: ${unidad} (${placas})`,
    `üë®‚Äçüíº Gerente: ${gerente}`,
    `üë®‚Äç‚úàÔ∏è Driver: ${driver}`,
    `üìû Tel: ${telefono}`,
    `üè™ Tienda: ${tienda}`,
    `üìç ${ciudad}, ${estado}`,
    `üì¶ Proyecto: ${proyecto}`,
    `üõ°Ô∏è Seguro: ${seguro}`,
    `üóíÔ∏è Descripci√≥n: ${descripcion}`
  ];
  return lines.join("\n");
}

// Env√≠a a SheetDB y abre WhatsApp con el resumen listo
async function enviarDatos() {
  const btn = document.getElementById("enviarBtn");
  const mensajeEl = document.getElementById("mensaje");
  const errorEl = document.getElementById("error");
  mensajeEl.textContent = "";
  errorEl.textContent = "";
  btn.disabled = true;

  try {
    // Generar folio
    const folio = await generarFolio();

    // Fecha/hora de env√≠o en zona CDMX (texto)
    const ahora = new Date();
    const fecha_envio = ahora.toLocaleDateString("es-MX", { timeZone: "America/Mexico_City" });
    const hora_envio = ahora.toLocaleTimeString("es-MX", { timeZone: "America/Mexico_City", hour12: false, hour: "2-digit", minute: "2-digit", second: "2-digit" });
    const fecha_hora_envio_iso = new Date(ahora.toLocaleString("en-US", { timeZone: "America/Mexico_City" })).toISOString();

    // Construir objeto para guardar
    const payload = {
      folio,
      fecha: valOrDash("fecha"),
      hora: valOrDash("hora"),
      placas: valOrDash("placas"),
      unidad: valOrDash("unidad"),
      gerente: valOrDash("gerente"),
      driver: valOrDash("driver"),
      telefonoDriver: valOrDash("telefonoDriver"),
      proyecto: valOrDash("proyecto"),
      tienda: valOrDash("tienda"),
      estado: valOrDash("estado"),
      ciudad: valOrDash("ciudad"),
      requiereSeguro: valOrDash("requiereSeguro"),
      descripcion: valOrDash("descripcion"),
      fecha_envio,
      hora_envio,
      fecha_hora_envio_iso
    };

    // Guardar en SheetDB (si no quieres guardar, comenta este bloque)
    const res = await fetch(SHEETDB_URL, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ data: [payload] })
    });
    if (!res.ok) {
      const txt = await res.text().catch(()=>"");
      console.warn("SheetDB returned non-ok:", res.status, txt);
      // no lanzamos error obligatorio; igual procedemos a abrir WhatsApp con el resumen.
    }

    // Construir resumen completamente relleno
    const resumen = construirResumen({ ...payload, folio, fecha_envio, hora_envio });

    // Mostrar confirmaci√≥n en la p√°gina
    mensajeEl.textContent = `‚úÖ Folio ${folio} registrado. Resumen listo para WhatsApp.`;

    // Abrir WhatsApp con mensaje prellenado (selector general)
    const texto = encodeURIComponent(resumen);
    window.open(`https://wa.me/?text=${texto}`, "_blank");

  } catch (err) {
    console.error("Error enviarDatos:", err);
    errorEl.textContent = "‚ùå Ocurri√≥ un error. Revisa la consola para m√°s detalles.";
  } finally {
    setTimeout(()=> btn.disabled = false, 800);
  }
}

document.getElementById("enviarBtn").addEventListener("click", enviarDatos);
</script>
</body>
</html>
