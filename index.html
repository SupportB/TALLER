<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Reporte de Evento</title>
  <style>
    body { font-family: Arial, sans-serif; background:#f0f4f8; color:#222; padding:20px; }
    form { max-width:640px; margin:auto; background:#fff; padding:24px; border-radius:10px; box-shadow:0 6px 20px rgba(0,0,0,0.08); }
    label{display:block;margin-top:12px;font-weight:700}
    input,select,textarea,button{width:100%;padding:10px;margin-top:6px;border-radius:8px;border:1px solid #ccc;font-size:15px;background:#fbfcfd}
    .row{display:flex;gap:10px;}
    .row>*{flex:1}
    button{background:#0077b6;color:#fff;border:0;cursor:pointer;font-weight:700}
    button[disabled]{opacity:0.6;cursor:not-allowed}
    #status{margin-top:12px;font-weight:700;text-align:center}
    #status.ok{color:green} #status.err{color:#c00} #status.info{color:#444}
  </style>
</head>
<body>
  <form id="formReporte" onsubmit="return false;">
    <h2 style="text-align:center;color:#0077b6">ğŸ“‹ Reporte de Evento</h2>

    <div class="row">
      <div>
        <label>ğŸ“… Fecha del evento</label>
        <input type="date" id="fechaEvento" required>
      </div>
      <div>
        <label>ğŸ•’ Hora del suceso</label>
        <input type="time" id="horaEvento" required>
      </div>
    </div>

    <label>ğŸš— Unidad</label>
    <input type="text" id="unidad">

    <label>ğŸ‘¨â€ğŸ’¼ Gerente</label>
    <input type="text" id="gerente">

    <label>ğŸ‘·â€â™‚ï¸ Driver</label>
    <input type="text" id="driver">

    <label>ğŸ“ TelÃ©fono</label>
    <input type="tel" id="telefono">

    <label>ğŸª Tienda</label>
    <input type="text" id="tienda">

    <label>ğŸ“ Ciudad / AlcaldÃ­a</label>
    <input type="text" id="ciudad_alcaldia">

    <label>ğŸ“ Proyecto</label>
    <input type="text" id="proyecto">

    <label>ğŸ›¡ï¸ Seguro</label>
    <select id="seguro">
      <option value="SÃ­">SÃ­</option>
      <option value="No" selected>No</option>
    </select>

    <label>ğŸ“ DescripciÃ³n</label>
    <textarea id="descripcion" rows="3"></textarea>

    <button id="botonEnviar" type="button">ğŸ“¤ Generar folio y enviar</button>
    <div id="status" role="status"></div>
  </form>

<script>
/* ---------------- CONFIGURA ---------------- */
const SHEETDB_URL = "https://sheetdb.io/api/v1/2nam4r8p6zvef"; // pega aquÃ­ tu endpoint SheetDB si tienes (ej: "https://sheetdb.io/api/v1/xxxx")
/* ------------------------------------------- */

/* --- Helpers folio (robustos) --- */
function extraerNumeroDesdeValor(valor) {
  if (!valor) return 0;
  const s = String(valor).trim();
  const m = s.match(/(\d+)$/);
  if (m) return parseInt(m[1], 10) || 0;
  const n = parseInt(s, 10);
  return Number.isFinite(n) ? n : 0;
}
function leerUltimoFolioNumero() {
  const raw = localStorage.getItem("ultimoFolio");
  return extraerNumeroDesdeValor(raw);
}
function confirmarFolioGuardado(numero) {
  const n = Number(numero) || 0;
  localStorage.setItem("ultimoFolio", String(n));
}
function obtenerSiguienteFolioPropuesto() {
  const ultimo = leerUltimoFolioNumero();
  const siguiente = ultimo + 1;
  return `FOL-${String(siguiente).padStart(4, "0")}`;
}

/* --- Util UI --- */
function vCampo(id) {
  const el = document.getElementById(id);
  return el ? (el.value || "").trim() : "";
}

/* --- Construir mensaje WhatsApp (interno) --- */
function construirResumenParaWhatsApp(datos) {
  return [
    "ğŸ“‹ *Reporte de Evento*",
    "",
    `ğŸ§¾ *Folio:* ${datos.folio}`,
    `ğŸ“… *Fecha evento:* ${datos.fechaEvento || "(no indicada)"}`,
    `ğŸ•’ *Hora suceso:* ${datos.horaEvento || "(no indicada)"}`,
    `â° *Registrado:* ${datos.fechaHoraEnvio}`,
    "",
    `ğŸš— *Unidad:* ${datos.unidad || "-"}`,
    `ğŸ‘¨â€ğŸ’¼ *Gerente:* ${datos.gerente || "-"}`,
    `ğŸ‘·â€â™‚ï¸ *Driver:* ${datos.driver || "-"}`,
    `ğŸ“ *Tel:* ${datos.telefono || "-"}`,
    `ğŸª *Tienda:* ${datos.tienda || "-"}`,
    `ğŸ“ *Ciudad/AlcaldÃ­a:* ${datos.ciudad_alcaldia || "-"}`,
    `ğŸ“ *Proyecto:* ${datos.proyecto || "-"}`,
    `ğŸ›¡ï¸ *Seguro:* ${datos.seguro || "-"}`,
    "",
    `ğŸ“ *DescripciÃ³n:*`,
    `${datos.descripcion || "-"}`
  ].join("\n");
}

/* --- Abrir WhatsApp (web) --- */
async function abrirWhatsAppConResumen(resumen) {
  const encoded = encodeURIComponent(resumen);
  const url = `https://api.whatsapp.com/send?text=${encoded}`;
  window.open(url, "_blank");
}

/* --- Handler principal --- */
document.getElementById("botonEnviar").addEventListener("click", async function () {
  const btn = this;
  const status = document.getElementById("status");
  btn.disabled = true;
  status.className = "";
  status.textContent = "Generando folio y registrando...";

  try {
    // generar folio internamente (no visible)
    const folio = obtenerSiguienteFolioPropuesto();
    const ahora = new Date();
    const fechaHoraEnvioISO = ahora.toISOString(); // ISO: recomendado para Sheets
    // preparar datos (fecha/hora del evento vienen del input)
    const datos = {
      folio,
      fechaEvento: vCampo("fechaEvento"),      // irÃ¡ a columna fecha_evento
      horaEvento: vCampo("horaEvento"),        // irÃ¡ a columna hora_suceso
      unidad: vCampo("unidad"),
      gerente: vCampo("gerente"),
      driver: vCampo("driver"),
      telefono: vCampo("telefono"),
      tienda: vCampo("tienda"),
      ciudad_alcaldia: vCampo("ciudad_alcaldia"),
      proyecto: vCampo("proyecto"),
      seguro: vCampo("seguro"),
      descripcion: vCampo("descripcion"),
      fechaHoraEnvio: fechaHoraEnvioISO
    };

    // Enviar a SheetDB (si estÃ¡ configurado) con los nombres exactos de columnas:
    // folio,fecha_evento,hora_suceso,unidad,gerente,driver,telefono,tienda,ciudad_alcaldia,proyecto,seguro,descripcion,fecha_hora_envio
    if (SHEETDB_URL && SHEETDB_URL.trim() !== "") {
      const payload = { data: [ {
        folio: datos.folio,
        fecha_evento: datos.fechaEvento,
        hora_suceso: datos.horaEvento,
        unidad: datos.unidad,
        gerente: datos.gerente,
        driver: datos.driver,
        telefono: datos.telefono,
        tienda: datos.tienda,
        ciudad_alcaldia: datos.ciudad_alcaldia,
        proyecto: datos.proyecto,
        seguro: datos.seguro,
        descripcion: datos.descripcion,
        fecha_hora_envio: datos.fechaHoraEnvio
      } ] };

      try {
        const res = await fetch(SHEETDB_URL, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(payload)
        });
        if (!res.ok) {
          const cuerpo = await res.text().catch(()=>"");
          throw new Error("SheetDB error: " + res.status + " " + cuerpo);
        }
        status.className = "ok";
        status.textContent = `âœ… Reporte enviado (Folio ${folio}) y guardado en servidor.`;
      } catch (err) {
        console.error("Error guardando en SheetDB:", err);
        status.className = "info";
        status.textContent = `â„¹ï¸ Reporte preparado con folio ${folio} (no se guardÃ³ en servidor).`;
      }
    } else {
      // No hay SheetDB configurado -> reservamos folio localmente y avisamos
      status.className = "info";
      status.textContent = `â„¹ï¸ Reporte preparado con folio ${folio} (no hay endpoint configurado).`;
    }

    // reservar folio localmente (evita repeticiÃ³n en este navegador)
    confirmarFolioGuardado(leerUltimoFolioNumero() + 1);

    // preparar y abrir WhatsApp (el resumen incluye fecha/hora de envÃ­o interna)
    const resumen = construirResumenParaWhatsApp(datos);
    await abrirWhatsAppConResumen(resumen);

  } catch (fatal) {
    console.error("Error en proceso:", fatal);
    status.className = "err";
    status.textContent = "âŒ OcurriÃ³ un error inesperado. Revisa la consola.";
  } finally {
    setTimeout(() => { btn.disabled = false; }, 900);
  }
});
</script>
</body>
</html>

