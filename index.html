<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Reporte de Evento â€” Sheets + WhatsApp (mÃ³vil y desktop)</title>
  <style>
    body { font-family: Arial, sans-serif; background:#f0f4f8; color:#222; padding:20px; }
    form { max-width:640px; margin:auto; background:#fff; padding:24px; border-radius:10px; box-shadow:0 6px 20px rgba(0,0,0,0.08); }
    label{display:block;margin-top:12px;font-weight:700}
    input,select,textarea,button{width:100%;padding:10px;margin-top:6px;border-radius:8px;border:1px solid #ccc;font-size:15px;background:#fbfcfd}
    .row{display:flex;gap:10px}
    .row>*{flex:1}
    button{background:#0077b6;color:#fff;border:0;cursor:pointer;font-weight:700}
    button[disabled]{opacity:0.6;cursor:not-allowed}
    #status{margin-top:12px;font-weight:700;text-align:center}
    #status.ok{color:green} #status.err{color:#c00} #status.info{color:#444}
  </style>
</head>
<body>
  <form id="formReporte" onsubmit="return false;">
    <h2 style="text-align:center;color:#0077b6">ğŸ“‹ Reporte de Evento</h2>

    <div class="row">
      <div>
        <label>ğŸ“… Fecha del evento</label>
        <input type="date" id="fechaEvento" required>
      </div>
      <div>
        <label>ğŸ•’ Hora del suceso</label>
        <input type="time" id="horaEvento" required>
      </div>
    </div>

    <label>ğŸš— Unidad</label><input type="text" id="unidad">
    <label>ğŸ‘¨â€ğŸ’¼ Gerente</label><input type="text" id="gerente">
    <label>ğŸ‘·â€â™‚ï¸ Driver</label><input type="text" id="driver">
    <label>ğŸ“ TelÃ©fono</label><input type="tel" id="telefono">
    <label>ğŸª Tienda</label><input type="text" id="tienda">
    <label>ğŸ“ Ciudad / AlcaldÃ­a</label><input type="text" id="ciudad_alcaldia">
    <label>ğŸ“ Proyecto</label><input type="text" id="proyecto">
    <label>ğŸ›¡ï¸ Seguro</label>
    <select id="seguro"><option value="SÃ­">SÃ­</option><option value="No" selected>No</option></select>
    <label>ğŸ“ DescripciÃ³n</label><textarea id="descripcion" rows="3"></textarea>

    <button id="botonEnviar" type="button">ğŸ“¤ Generar folio, guardar y abrir WhatsApp</button>
    <div id="status" role="status"></div>
  </form>

<script>
/* --------- CONFIGURA: pega aquÃ­ tu endpoint SheetDB si aplica --------- */
const SHEETDB_URL = "https://sheetdb.io/api/v1/2nam4r8p6zvef"; // ejemplo: "https://sheetdb.io/api/v1/xxxxxx"
/* -------------------------------------------------------------------- */

/* --- Helpers folio --- */
function extraerNumeroDesdeValor(valor) {
  if (!valor) return 0;
  const s = String(valor).trim();
  const m = s.match(/(\d+)$/);
  if (m) return parseInt(m[1], 10) || 0;
  const n = parseInt(s, 10);
  return Number.isFinite(n) ? n : 0;
}
function leerUltimoFolioNumero() {
  return extraerNumeroDesdeValor(localStorage.getItem("ultimoFolio"));
}
function confirmarFolioGuardado(numero) {
  const n = Number(numero) || 0;
  localStorage.setItem("ultimoFolio", String(n));
}
function obtenerSiguienteFolioPropuesto() {
  const ultimo = leerUltimoFolioNumero();
  const siguiente = ultimo + 1;
  return `FOL-${String(siguiente).padStart(4, "0")}`;
}

/* --- Util --- */
function vCampo(id){ const el = document.getElementById(id); return el ? (el.value || "").trim() : ""; }
function esDispositivoMovil() {
  return /Android|iPhone|iPad|iPod/i.test(navigator.userAgent);
}

/* --- Construir texto para WhatsApp --- */
function construirResumenParaWhatsApp(datos) {
  return [
    "ğŸ“‹ Reporte de Evento",
    "",
    `ğŸ§¾ Folio: ${datos.folio}`,
    `ğŸ“… Fecha evento: ${datos.fechaEvento || "(no indicada)"}`,
    `ğŸ•’ Hora suceso: ${datos.horaEvento || "(no indicada)"}`,
    `â° Registrado: ${datos.fechaHoraEnvio}`,
    "",
    `ğŸš— Unidad: ${datos.unidad || "-"}`,
    `ğŸ‘¨â€ğŸ’¼ Gerente: ${datos.gerente || "-"}`,
    `ğŸ‘·â€â™‚ï¸ Driver: ${datos.driver || "-"}`,
    `ğŸ“ Tel: ${datos.telefono || "-"}`,
    `ğŸª Tienda: ${datos.tienda || "-"}`,
    `ğŸ“ Ciudad/AlcaldÃ­a: ${datos.ciudad_alcaldia || "-"}`,
    `ğŸ“ Proyecto: ${datos.proyecto || "-"}`,
    `ğŸ›¡ï¸ Seguro: ${datos.seguro || "-"}`,
    "",
    `ğŸ“ DescripciÃ³n:`,
    `${datos.descripcion || "-"}`
  ].join("\n");
}

/* --- Copiar al portapapeles (fallback) --- */
async function copiarAlPortapapeles(texto) {
  if (navigator.clipboard && navigator.clipboard.writeText) return navigator.clipboard.writeText(texto);
  const ta = document.createElement("textarea"); ta.value = texto; document.body.appendChild(ta); ta.select();
  document.execCommand("copy"); document.body.removeChild(ta);
}

/* --- Enviar payload mediante sendBeacon (si disponible) --- */
function enviarConBeacon(url, payloadObj) {
  try {
    const blob = new Blob([JSON.stringify(payloadObj)], { type: "application/json" });
    return navigator.sendBeacon(url, blob);
  } catch (e) {
    console.warn("sendBeacon no disponible o fallÃ³:", e);
    return false;
  }
}

/* --- CLICK handler --- */
document.getElementById("botonEnviar").addEventListener("click", async function () {
  const btn = this;
  const status = document.getElementById("status");
  btn.disabled = true;
  status.className = "";
  status.textContent = "Generando folio y preparando envÃ­o...";

  try {
    // 1) Generar folio y preparar datos/resumen
    const folio = obtenerSiguienteFolioPropuesto();
    const ahora = new Date();
    const fechaHoraEnvioISO = ahora.toISOString();

    const datos = {
      folio,
      fechaEvento: vCampo("fechaEvento"),
      horaEvento: vCampo("horaEvento"),
      unidad: vCampo("unidad"),
      gerente: vCampo("gerente"),
      driver: vCampo("driver"),
      telefono: vCampo("telefono"),
      tienda: vCampo("tienda"),
      ciudad_alcaldia: vCampo("ciudad_alcaldia"),
      proyecto: vCampo("proyecto"),
      seguro: vCampo("seguro"),
      descripcion: vCampo("descripcion"),
      fechaHoraEnvio: fechaHoraEnvioISO
    };

    const resumen = construirResumenParaWhatsApp(datos);
    const webUrl = `https://api.whatsapp.com/send?text=${encodeURIComponent(resumen)}`;
    const appUrl = `whatsapp://send?text=${encodeURIComponent(resumen)}`;

    // 2) Si es desktop -> abrir ventana vacÃ­a (gesture) y luego fetch -> asignar url a esa ventana
    if (!esDispositivoMovil()) {
      let win = null;
      try { win = window.open("", "_blank"); } catch (e) { win = null; }

      // Hacemos fetch normalmente (await) para asegurar guardado antes de redirigir
      let guardadoOK = false;
      if (SHEETDB_URL && SHEETDB_URL.trim() !== "") {
        const payload = { data: [ {
          folio: datos.folio,
          fecha_evento: datos.fechaEvento,
          hora_suceso: datos.horaEvento,
          unidad: datos.unidad,
          gerente: datos.gerente,
          driver: datos.driver,
          telefono: datos.telefono,
          tienda: datos.tienda,
          ciudad_alcaldia: datos.ciudad_alcaldia,
          proyecto: datos.proyecto,
          seguro: datos.seguro,
          descripcion: datos.descripcion,
          fecha_hora_envio: datos.fechaHoraEnvio
        } ] };

        try {
          const res = await fetch(SHEETDB_URL, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(payload)
          });
          if (!res.ok) {
            const cuerpo = await res.text().catch(()=>"");
            throw new Error("SheetDB error: " + res.status + " " + cuerpo);
          }
          guardadoOK = true;
        } catch (err) {
          console.error("Error guardando en SheetDB:", err);
          guardadoOK = false;
        }
      }

      // reservar folio localmente
      confirmarFolioGuardado(leerUltimoFolioNumero() + 1);

      // status
      if (guardadoOK) {
        status.className = "ok";
        status.textContent = `âœ… Reporte guardado (Folio ${folio}). Abriendo WhatsApp...`;
      } else {
        status.className = "info";
        status.textContent = `â„¹ï¸ Reporte preparado (Folio ${folio}). Abriendo WhatsApp...`;
      }

      // abrir WhatsApp en la ventana creada
      if (win) {
        try {
          win.location = appUrl;
          setTimeout(()=>{ try{ if (win && !win.closed) win.location = webUrl; }catch(e){console.warn(e);} }, 900);
        } catch(e) {
          try { win.location = webUrl; } catch(e2){ console.warn(e2); }
        }
      } else {
        // si popup bloqueado, fallback: copiar y abrir web en nueva pestaÃ±a si posible
        try {
          await copiarAlPortapapeles(resumen);
          alert("Se copiÃ³ el resumen al portapapeles. Pega el texto en WhatsApp para enviar.");
        } catch(e) {
          try { window.open(webUrl, "_blank"); } catch(e2){ console.warn(e2); }
        }
      }

    } else {
      // 3) MÃ“VIL: abrimos app de whatsapp inmediatamente y usamos sendBeacon o fetch no bloqueante
      // Intentar enviar con sendBeacon (ideal en mobile)
      let beaconOk = false;
      if (SHEETDB_URL && SHEETDB_URL.trim() !== "" && navigator.sendBeacon) {
        const payload = {
          data: [ {
            folio: datos.folio,
            fecha_evento: datos.fechaEvento,
            hora_suceso: datos.horaEvento,
            unidad: datos.unidad,
            gerente: datos.gerente,
            driver: datos.driver,
            telefono: datos.telefono,
            tienda: datos.tienda,
            ciudad_alcaldia: datos.ciudad_alcaldia,
            proyecto: datos.proyecto,
            seguro: datos.seguro,
            descripcion: datos.descripcion,
            fecha_hora_envio: datos.fechaHoraEnvio
          } ]
        };
        try {
          beaconOk = enviarConBeacon(SHEETDB_URL, payload);
        } catch(e){ beaconOk = false; }
      }

      // Si no hubo beacon, hacemos fetch "no bloqueante" (no await) â€” best-effort
      if (!beaconOk && SHEETDB_URL && SHEETDB_URL.trim() !== "") {
        const payload = { data: [ {
          folio: datos.folio,
          fecha_evento: datos.fechaEvento,
          hora_suceso: datos.horaEvento,
          unidad: datos.unidad,
          gerente: datos.gerente,
          driver: datos.driver,
          telefono: datos.telefono,
          tienda: datos.tienda,
          ciudad_alcaldia: datos.ciudad_alcaldia,
          proyecto: datos.proyecto,
          seguro: datos.seguro,
          descripcion: datos.descripcion,
          fecha_hora_envio: datos.fechaHoraEnvio
        } ] };
        // fire-and-forget
        fetch(SHEETDB_URL, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(payload)
        }).then(r => {
          if (!r.ok) console.warn("SheetDB returned non-ok on mobile:", r.status);
        }).catch(e => console.warn("Mobile fetch error (may be aborted if user leaves):", e));
      }

      // reservar folio localmente
      confirmarFolioGuardado(leerUltimoFolioNumero() + 1);

      status.className = "info";
      status.textContent = `â„¹ï¸ Abriendo WhatsApp. Folio: ${folio}`;

      // Abrir la app de WhatsApp (preferible en mÃ³vil)
      try {
        // Primer intento: intentar abrir app
        window.location.href = appUrl;
        // DespuÃ©s de breve timeout forzamos fallback a web (si la app no abre)
        setTimeout(() => {
          try { window.location.href = webUrl; } catch(e){ console.warn(e); }
        }, 900);
      } catch (e) {
        // fallback
        try { window.location.href = webUrl; } catch(e2){ console.warn(e2); }
      }
    }

  } catch (fatal) {
    console.error("Error en proceso:", fatal);
    status.className = "err";
    status.textContent = "âŒ OcurriÃ³ un error. Revisa la consola.";
  } finally {
    setTimeout(()=>{ btn.disabled = false; }, 900);
  }
});
</script>
</body>
</html>


